// üëá Mets ici l‚ÄôURL du d√©ploiement Web App Apps Script (celui du projet "Compta perso")
const ENDPOINT = "https://script.google.com/macros/s/TON_ID_EXEC/exec";

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

const $ = id => document.getElementById(id);
const blocs = {
  "Achat stock":"bloc-achat",
  "Frais annexes":"bloc-frais",
  "Vente/Cashout":"bloc-vente",
  "Abonnement (mensuel)":"bloc-abo",
  "Paiement":"bloc-paiement"
};

function switchTypeUI(){
  const t = $("type").value;
  Object.values(blocs).forEach(id=>$(id).classList.add("hidden"));
  $(blocs[t]).classList.remove("hidden");
}
$("type").addEventListener("change", switchTypeUI);

function fillSelect(sel, arr){ sel.innerHTML = ""; (arr||[]).forEach(v=>{ const o=document.createElement("option"); o.value=o.textContent=v; sel.appendChild(o); }); }

async function loadLists(){
  try{
    const r = await fetch(ENDPOINT + "?api=lists");
    const json = await r.json();
    const d = json.data || {};
    fillSelect($("fournisseur"), d.fournisseurs);
    fillSelect($("categorie"), d.categories);
    fillSelect($("compte-vinted"), d.comptesVinted);
    fillSelect($("abo-categorie"), d.categories);
  }catch(e){
    $("error").textContent = "Erreur listes: " + e.message;
    $("error").style.display = "block";
  }
}

// + ajouter (Parametres)
document.body.addEventListener("click", async (e)=>{
  if(!e.target.matches(".add-link")) return;
  const kind = e.target.getAttribute("data-kind");
  const labels = { categorie:"Nouvelle cat√©gorie", fournisseur:"Nouveau fournisseur", compteVinted:"Nouveau compte Vinted" };
  const val = prompt((labels[kind]||"Nouvelle valeur")+" :");
  if(!val) return;

  try{
    const body = new URLSearchParams({ action:"addParam", kind, value:val }).toString();
    const r = await fetch(ENDPOINT, {
      method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body
    });
    const json = await r.json();
    if(!json.ok) throw new Error(json.error || "Erreur ajout param√®tre");
    const d = json.data || {};
    if(kind==="fournisseur") fillSelect($("fournisseur"), d.fournisseurs||[]);
    if(kind==="categorie"){ fillSelect($("categorie"), d.categories||[]); fillSelect($("abo-categorie"), d.categories||[]); }
    if(kind==="compteVinted") fillSelect($("compte-vinted"), d.comptesVinted||[]);
  }catch(err){ alert("Erreur: " + err.message); }
});

(function setToday(){
  const t=new Date(), yyyy=t.getFullYear(), mm=String(t.getMonth()+1).padStart(2,"0"), dd=String(t.getDate()).padStart(2,"0");
  $("date-achat").value=`${yyyy}-${mm}-${dd}`;
  $("date-frais").value=`${yyyy}-${mm}-${dd}`;
  $("date-vente").value=`${yyyy}-${mm}-${dd}`;
  $("date-paiement").value=`${yyyy}-${mm}-${dd}`;
})();

$("submit").addEventListener("click", async ()=>{
  $("submit").disabled=true; $("feedback").style.display="none"; $("error").style.display="none";
  const type=$("type").value; const p={ type };

  const need = v => v!=null && String(v).trim()!=="";

  if(type==="Achat stock"){
    if(!need($("montant-achat").value)) return onErr("Montant requis.");
    p.item=$("item").value; p.dateISO=$("date-achat").value; p.montant=$("montant-achat").value; p.fournisseur=$("fournisseur").value;
  } else if(type==="Frais annexes"){
    if(!need($("montant-frais").value)) return onErr("Montant requis.");
    p.fraisDesc=$("frais-desc").value; p.dateISO=$("date-frais").value; p.montant=$("montant-frais").value; p.categorie=$("categorie").value;
  } else if(type==="Vente/Cashout"){
    if(!need($("montant-vente").value)) return onErr("Montant requis.");
    p.dateISO=$("date-vente").value; p.montant=$("montant-vente").value; p.compteVinted=$("compte-vinted").value;
  } else if(type==="Abonnement (mensuel)"){
    if(!need($("abo-montant").value)) return onErr("Montant requis.");
    p.aboNom=$("abo-nom").value; p.montant=$("abo-montant").value; p.aboJour=$("abo-jour").value; p.categorie=$("abo-categorie").value; p.aboActif=$("abo-actif").checked;
  } else {
    if(!need($("montant-paiement").value)) return onErr("Montant requis.");
    p.dateISO=$("date-paiement").value; p.montant=$("montant-paiement").value;
  }

  try{
    const form = new URLSearchParams(); Object.entries(p).forEach(([k,v])=>form.append(k,String(v)));
    const r = await fetch(ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body: form.toString() });
    const json = await r.json().catch(()=>({}));
    if(!r.ok || json.ok===false) throw new Error(json.error || ("HTTP "+r.status));

    $("feedback").textContent="Ajout√© ‚úÖ"; $("feedback").style.display="block";
    if(type==="Achat stock"){ $("item").value=""; $("montant-achat").value=""; }
    else if(type==="Frais annexes"){ $("frais-desc").value=""; $("montant-frais").value=""; }
    else if(type==="Vente/Cashout"){ $("montant-vente").value=""; }
    else if(type==="Abonnement (mensuel)"){ $("abo-nom").value=""; $("abo-montant").value=""; }
    else { $("montant-paiement").value=""; }
  }catch(e){
    $("error").textContent="Erreur: "+e.message; $("error").style.display="block";
  }finally{ $("submit").disabled=false; }
});

function onErr(msg){ $("error").textContent=msg; $("error").style.display="block"; $("submit").disabled=false; }
switchTypeUI();
loadLists();

// PWA: (re)charge le SW √† chaque d√©ploiement (bump version dans sw.js)
if("serviceWorker" in navigator){ navigator.serviceWorker.register("sw.js"); }
