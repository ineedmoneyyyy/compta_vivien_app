<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Saisie rapide</title>
  <meta name="viewport" content="width=390, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="logo1.png" />
  <style>
    :root{
      --primary:#6f57d3; --bg:#f2f2f7; --fg:#111; --border:#d9d9de;
      --r:16px; --pad:18px; --maxw:390px;
    }
    html,body{height:100%;}
    body{
      margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      font-size:18px; line-height:1.35; -webkit-text-size-adjust:100%;
      overflow-x:hidden;
    }
    .screen{min-height:100vh; display:flex; flex-direction:column;}
    .wrap{ width:100%; max-width:var(--maxw); margin:0 auto; box-sizing:border-box; padding:0 var(--pad); }

    /* ===== Bandeau GIF : FIN, NON ROGNÉ, ARRONDI, SANS FOND ===== */
    .header{ padding:10px var(--pad) 0; }
    .gif-box{
      width:100%; height:56px; border-radius:22px; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .gif-box img{
      width:100%; height:100%; object-fit:contain; display:block;
    }

    label{ display:block; font-weight:700; margin:14px 0 8px; }

    input, select{
      width:100%; box-sizing:border-box; background:#fff; border:1px solid var(--border); border-radius:12px;
      padding:12px 14px; font-size:18px; min-height:50px; outline:none;
    }
    /* Flèche bleue sur les listes */
    select{
      appearance:none; -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, #6fa8ff 50%),
        linear-gradient(135deg, #6fa8ff 50%, transparent 50%);
      background-position:
        calc(100% - 20px) calc(50% - 3px),
        calc(100% - 14px) calc(50% - 3px);
      background-size:6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }

    .row{ display:flex; gap:16px; align-items:flex-start; margin-bottom:8px; }
    .field{ flex:1; min-width:0; }
    .hint{ font-size:14px; color:#666; margin-top:6px; }

    .actions{ padding:16px var(--pad) calc(env(safe-area-inset-bottom,0) + 16px); }
    #submit{
      width:100%; height:60px; border:none; border-radius:16px; background:var(--primary); color:#fff;
      font-size:20px; font-weight:800; letter-spacing:.2px; box-shadow:0 10px 24px rgba(111,87,211,.25);
      cursor:pointer; touch-action:manipulation;
    }
    #submit:disabled{ opacity:.6; cursor:not-allowed; }
    .msg{ font-size:16px; margin-top:8px; }
    .ok{ color:#0a8a0a; } .err{ color:#c62828; }

    .link{ background:none; border:none; color:#6f57d3; text-decoration:underline; padding:0; cursor:pointer; font-size:16px; }

    /* Toggle Actif */
    .toggle{ display:flex; align-items:center; gap:12px; margin-top:8px; }
    .toggle input[type="checkbox"]{ width:44px; height:26px; }
  </style>
</head>
<body>
  <div class="screen">
    <header class="header wrap">
      <div class="gif-box"><img src="go.gif" alt="I Need Resell"></div>
    </header>

    <main class="wrap" style="padding-bottom:8px;">
      <label>Type de transaction</label>
      <select id="type">
        <option>Achat stock</option>
        <option>Frais annexes</option>
        <option>Vente/Cashout</option>
        <option>Abonnement (mensuel)</option>
        <option>Paiement</option>
      </select>

      <!-- ACHAT -->
      <div id="bloc-achat" class="bloc">
        <label>Item / Référence</label>
        <input id="item" type="text" placeholder="Ex: 100 Jeans Levi's 501">
        <div class="row">
          <div class="field">
            <label>Date</label>
            <input id="date-achat" type="date">
          </div>
          <div class="field">
            <label>Montant (€)</label>
            <input id="montant-achat" type="text" inputmode="decimal" placeholder="ex: 79,90">
            <div class="hint">Décimales : virgule ou point</div>
          </div>
        </div>
        <label>Fournisseur</label>
        <select id="fournisseur"></select>
        <div><button class="link" data-kind="fournisseur">+ ajouter</button></div>
      </div>

      <!-- FRAIS -->
      <div id="bloc-frais" class="bloc" style="display:none;">
        <label>Description du frais</label>
        <input id="frais-desc" type="text" placeholder="Ex: URSSAF, pochettes, etc.">
        <div class="row">
          <div class="field">
            <label>Date</label>
            <input id="date-frais" type="date">
          </div>
          <div class="field">
            <label>Montant (€)</label>
            <input id="montant-frais" type="text" inputmode="decimal" placeholder="ex: 12,50">
          </div>
        </div>
        <label>Catégorie</label>
        <select id="categorie"></select>
        <div><button class="link" data-kind="categorie">+ ajouter</button></div>
      </div>

      <!-- VENTE -->
      <div id="bloc-vente" class="bloc" style="display:none;">
        <div class="row">
          <div class="field">
            <label>Date</label>
            <input id="date-vente" type="date">
          </div>
          <div class="field">
            <label>Montant (€)</label>
            <input id="montant-vente" type="text" inputmode="decimal" placeholder="ex: 45">
          </div>
        </div>
        <label>Compte Vinted</label>
        <select id="compte-vinted"></select>
        <div><button class="link" data-kind="compteVinted">+ ajouter</button></div>
      </div>

      <!-- ABONNEMENT -->
      <div id="bloc-abo" class="bloc" style="display:none;">
        <label>Nom de l’abonnement</label>
        <input id="abo-nom" type="text" placeholder="Ex: ChatGPT Plus">
        <div class="row">
          <div class="field">
            <label>Montant (€)</label>
            <input id="abo-montant" type="text" inputmode="decimal" placeholder="ex: 20">
          </div>
          <div class="field">
            <label>Jour du mois</label>
            <input id="abo-jour" type="number" min="1" max="31" value="5">
          </div>
        </div>
        <label>Catégorie</label>
        <select id="abo-categorie"></select>
        <div><button class="link" data-kind="categorie">+ ajouter</button></div>
        <div class="toggle">
          <input id="abo-actif" type="checkbox" checked>
          <label for="abo-actif" style="margin:0;font-weight:700;">Actif</label>
        </div>
      </div>

      <!-- PAIEMENT -->
      <div id="bloc-paiement" class="bloc" style="display:none;">
        <div class="row">
          <div class="field">
            <label>Date</label>
            <input id="date-paiement" type="date">
          </div>
          <div class="field">
            <label>Montant (€)</label>
            <input id="montant-paiement" type="text" inputmode="decimal" placeholder="ex: 1000">
          </div>
        </div>
      </div>

      <div id="msg" class="msg"></div>
    </main>

    <div class="actions">
      <div class="wrap"><button id="submit">+ Ajouter</button></div>
    </div>
  </div>

  <script>
    // ====== Ton Apps Script ======
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzF3P3AE1hcHuyFRZLnBS9eKtu0nz1jVyLxv8Ej0CbA78G-_ssXd2e-I9zgk58qqke46w/exec";

    const $ = id => document.getElementById(id);
    const blocs = {
      "Achat stock":"bloc-achat",
      "Frais annexes":"bloc-frais",
      "Vente/Cashout":"bloc-vente",
      "Abonnement (mensuel)":"bloc-abo",
      "Paiement":"bloc-paiement"
    };

    function showBloc(){
      const t = $("type").value;
      Object.values(blocs).forEach(id => document.getElementById(id).style.display = "none");
      document.getElementById(blocs[t]).style.display = "block";
      $("#msg").className="msg"; $("#msg").textContent="";
    }
    $("type").addEventListener("change", showBloc);

    function todayISO(){
      const t=new Date(), y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,"0"), d=String(t.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    ["date-achat","date-frais","date-vente","date-paiement"].forEach(id => { const el=$(id); if(el) el.value=todayISO(); });

    function fillSelect(el, arr){ el.innerHTML = (arr||[]).map(v=>`<option>${v}</option>`).join(""); }

    async function loadLists(){
      try{
        const r=await fetch(ENDPOINT+"?api=lists");
        const {data}=await r.json();
        fillSelect($("fournisseur"), data.fournisseurs);
        fillSelect($("categorie"), data.categories);
        fillSelect($("compte-vinted"), data.comptesVinted);
        fillSelect($("abo-categorie"), data.categories);
      }catch(e){
        $("#msg").className="msg err"; $("#msg").textContent="Erreur listes : "+e.message;
      }
    }
    loadLists(); showBloc();

    // Ajout dans Paramètres
    document.body.addEventListener("click", async (e)=>{
      if(!e.target.matches(".link")) return;
      const kind = e.target.getAttribute("data-kind");
      const labels = {fournisseur:"Nouveau fournisseur", categorie:"Nouvelle catégorie", compteVinted:"Nouveau compte Vinted"};
      const val = prompt(labels[kind]+" :");
      if(!val) return;
      const btn = e.target, original = btn.textContent;
      try{
        btn.textContent = "Ajout en cours…";
        const params = new URLSearchParams();
        params.append("action","addParam");
        params.append("kind", kind);
        params.append("value", val);
        const r = await fetch(ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
          body: params.toString()
        });
        const json = await r.json();
        if(!json.ok) throw new Error(json.error||"Erreur ajout");
        const d = json.data || {};
        if(kind==="fournisseur") fillSelect($("fournisseur"), d.fournisseurs||[]);
        if(kind==="categorie"){ fillSelect($("categorie"), d.categories||[]); fillSelect($("abo-categorie"), d.categories||[]); }
        if(kind==="compteVinted") fillSelect($("compte-vinted"), d.comptesVinted||[]);
        btn.textContent = "Ajouté ✅";
        setTimeout(()=>btn.textContent=original, 900);
      }catch(err){
        alert("Erreur: "+err.message);
        btn.textContent = original;
      }
    });

    function need(v){ return v!=null && String(v).trim()!==""; }
    function validate(type){
      if(type==="Achat stock"){
        return need($("#item").value) && need($("#date-achat").value) && need($("#montant-achat").value) && need($("#fournisseur").value);
      } else if(type==="Frais annexes"){
        return need($("#frais-desc").value) && need($("#date-frais").value) && need($("#montant-frais").value) && need($("#categorie").value);
      } else if(type==="Vente/Cashout"){
        return need($("#date-vente").value) && need($("#montant-vente").value) && need($("#compte-vinted").value);
      } else if(type==="Abonnement (mensuel)"){
        return need($("#abo-nom").value) && need($("#abo-montant").value) && need($("#abo-jour").value) && need($("#abo-categorie").value);
      } else {
        return need($("#date-paiement").value) && need($("#montant-paiement").value);
      }
    }
    function clearFields(type){
      if(type==="Achat stock"){
        $("#item").value=""; $("#montant-achat").value="";
      } else if(type==="Frais annexes"){
        $("#frais-desc").value=""; $("#montant-frais").value="";
      } else if(type==="Vente/Cashout"){
        $("#montant-vente").value="";
      } else if(type==="Abonnement (mensuel)"){
        $("#abo-nom").value=""; $("#abo-montant").value=""; $("#abo-jour").value="5"; $("#abo-actif").checked = true;
      } else { $("#montant-paiement").value=""; }
    }

    $("#submit").addEventListener("click", async ()=>{
      const type = $("#type").value;
      $("#msg").className="msg"; $("#msg").textContent="";
      if(!validate(type)){
        $("#msg").className="msg err"; $("#msg").textContent="Merci de remplir tous les champs requis.";
        return;
      }

      $("#submit").disabled = true;
      const originalBtn = $("#submit").textContent;
      $("#submit").textContent = "Ajout en cours…";

      const p = new URLSearchParams();
      p.append("type", type);

      if(type==="Achat stock"){
        p.append("item", $("#item").value);
        p.append("dateISO", $("#date-achat").value);
        p.append("montant", $("#montant-achat").value);
        p.append("fournisseur", $("#fournisseur").value);
      } else if(type==="Frais annexes"){
        p.append("fraisDesc", $("#frais-desc").value);
        p.append("dateISO", $("#date-frais").value);
        p.append("montant", $("#montant-frais").value);
        p.append("categorie", $("#categorie").value);
      } else if(type==="Vente/Cashout"){
        p.append("dateISO", $("#date-vente").value);
        p.append("montant", $("#montant-vente").value);
        p.append("compteVinted", $("#compte-vinted").value);
      } else if(type==="Abonnement (mensuel)"){
        p.append("aboNom", $("#abo-nom").value);
        p.append("montant", $("#abo-montant").value);
        p.append("aboJour", $("#abo-jour").value);
        p.append("categorie", $("#abo-categorie").value);
        p.append("aboActif", $("#abo-actif").checked ? "true" : "false");
      } else {
        p.append("dateISO", $("#date-paiement").value);
        p.append("montant", $("#montant-paiement").value);
      }

      try{
        const r = await fetch(ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
          body: p.toString()
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || j.ok===false) throw new Error(j.error || ("HTTP "+r.status));
        $("#msg").className="msg ok"; $("#msg").textContent="Ajouté ✅";
        clearFields(type);
      }catch(e){
        $("#msg").className="msg err"; $("#msg").textContent="Erreur : "+e.message;
      }finally{
        $("#submit").disabled = false;
        $("#submit").textContent = originalBtn;
      }
    });
  </script>
</body>
</html>
