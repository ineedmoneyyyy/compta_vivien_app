<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>I Need Resell — Saisie rapide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="logo1.png" />

  <style>
    :root{
      --primary:#6f57d3; --bg:#f2f2f7; --fg:#111; --border:#d9d9de;
      --pad:18px; --maxw:640px; --radius:16px;
      --accent:#267dff; /* flèche bleue */
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.35; -webkit-text-size-adjust:100%;
    }
    .screen{min-height:100vh; display:flex; flex-direction:column;}
    /* Header GIF */
    .header{background:var(--bg)}
    .header .wrap{max-width:var(--maxw); margin:0 auto; padding:8px var(--pad) 0}
    .hero{
      width:100%; height:200px; border-radius:14px; overflow:hidden;
      background:#e9e9ef;
      display:flex; align-items:center; justify-content:center;
    }
    .hero img{width:100%; height:100%; object-fit:cover; display:block}
    /* Contenu */
    .wrap{max-width:var(--maxw); margin:0 auto; padding:12px var(--pad)}
    label.title{display:block; font-weight:800; font-size:18px; margin:14px 0 8px}
    .row{display:flex; gap:14px}
    .row .field{flex:1; min-width:0}
    input, select{
      width:100%; box-sizing:border-box; border:1px solid var(--border); background:#fff;
      border-radius:14px; padding:14px 16px; font-size:17px; min-height:52px; outline:none;
    }
    input:focus,select:focus{border-color:#c7b8ff; box-shadow:0 0 0 3px rgba(111,87,211,.15)}
    .hint{font-size:13px; color:#666; margin:6px 2px 0}

    /* Flèche bleue sur tous les selects */
    .select-wrap{position:relative}
    .select-wrap select{appearance:none; -webkit-appearance:none; padding-right:44px}
    .select-wrap::after{
      content:""; position:absolute; right:12px; top:50%; transform:translateY(-50%);
      width:22px; height:22px;
      background:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='%23267dff' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><polyline points='7 10 12 15 17 10'/></svg>")
        center/22px 22px no-repeat;
      pointer-events:none;
    }

    /* Case Actif (zone tactile large) */
    .toggle{
      display:flex; align-items:center; gap:10px; margin-top:10px; user-select:none;
      padding:8px 2px;
    }
    .toggle input{width:22px; height:22px}

    /* Actions */
    .actions{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(242,242,247,0) 0%, var(--bg) 50%); padding:12px 0 calc(env(safe-area-inset-bottom,0) + 12px)}
    .actions .wrap{padding-top:0}
    #submit{
      width:100%; height:60px; border:none; border-radius:18px; background:var(--primary); color:#fff;
      font-size:20px; font-weight:800; letter-spacing:.2px; box-shadow:0 10px 24px rgba(111,87,211,.25);
      cursor:pointer; touch-action:manipulation;
    }
    #submit:disabled{opacity:.6; cursor:default}

    /* Spinner */
    .spin{display:inline-block; width:18px; height:18px; border:3px solid rgba(255,255,255,.45); border-top-color:#fff; border-radius:50%; margin-right:10px; vertical-align:-3px; animation:rt 0.8s linear infinite}
    @keyframes rt{to{transform:rotate(360deg)}}

    .msg{font-size:15px; color:#0a8a0a; margin-top:8px}
    .err{font-size:15px; color:#c62828; margin-top:8px}
  </style>
</head>
<body>
  <div class="screen">
    <!-- HEADER avec GIF -->
    <header class="header">
      <div class="wrap">
        <div class="hero">
          <!-- important : même nom que dans le repo -->
          <img src="go.gif" alt="Header">
        </div>
      </div>
    </header>

    <!-- CONTENU -->
    <main class="wrap">
      <label class="title">Type de transaction</label>
      <div class="select-wrap">
        <select id="type">
          <option>Achat stock</option>
          <option>Frais annexes</option>
          <option>Vente/Cashout</option>
          <option>Abonnement (mensuel)</option>
          <option>Paiement</option>
        </select>
      </div>

      <!-- ACHAT -->
      <div id="bloc-achat" class="bloc">
        <label class="title">Item / Référence</label>
        <input id="item" type="text" placeholder="Ex: 100 Jeans Levi's 501">

        <div class="row">
          <div class="field">
            <label class="title">Date</label>
            <input id="date-achat" type="date">
          </div>
          <div class="field">
            <label class="title">Montant (€)</label>
            <input id="montant-achat" type="text" inputmode="decimal" placeholder="ex: 79,90">
            <div class="hint">Décimales : virgule ou point</div>
          </div>
        </div>

        <label class="title">Fournisseur</label>
        <div class="select-wrap"><select id="fournisseur"></select></div>
        <div class="hint" style="text-align:right"><button id="add-fs" type="button" style="border:none;background:none;color:#6f57d3;text-decoration:underline;padding:0">+ ajouter</button></div>
      </div>

      <!-- FRAIS -->
      <div id="bloc-frais" class="bloc" style="display:none">
        <label class="title">Description du frais</label>
        <input id="frais-desc" type="text" placeholder="Ex: Pochettes, URSSAF, etc.">

        <div class="row">
          <div class="field">
            <label class="title">Date</label>
            <input id="date-frais" type="date">
          </div>
          <div class="field">
            <label class="title">Montant (€)</label>
            <input id="montant-frais" type="text" inputmode="decimal" placeholder="ex: 12,50">
            <div class="hint">Décimales : virgule ou point</div>
          </div>
        </div>

        <label class="title">Catégorie</label>
        <div class="select-wrap"><select id="categorie"></select></div>
        <div class="hint" style="text-align:right"><button id="add-cat" type="button" style="border:none;background:none;color:#6f57d3;text-decoration:underline;padding:0">+ ajouter</button></div>
      </div>

      <!-- VENTE -->
      <div id="bloc-vente" class="bloc" style="display:none">
        <div class="row">
          <div class="field">
            <label class="title">Date</label>
            <input id="date-vente" type="date">
          </div>
          <div class="field">
            <label class="title">Montant (€)</label>
            <input id="montant-vente" type="text" inputmode="decimal" placeholder="ex: 45">
            <div class="hint">Décimales : virgule ou point</div>
          </div>
        </div>

        <label class="title">Compte Vinted</label>
        <div class="select-wrap"><select id="compte-vinted"></select></div>
        <div class="hint" style="text-align:right"><button id="add-vinted" type="button" style="border:none;background:none;color:#6f57d3;text-decoration:underline;padding:0">+ ajouter</button></div>
      </div>

      <!-- ABONNEMENT -->
      <div id="bloc-abo" class="bloc" style="display:none">
        <label class="title">Nom de l’abonnement</label>
        <input id="abo-nom" type="text" placeholder="Ex: ChatGPT Plus">

        <div class="row">
          <div class="field">
            <label class="title">Montant (€)</label>
            <input id="abo-montant" type="text" inputmode="decimal" placeholder="ex: 20">
            <div class="hint">Décimales : virgule ou point</div>
          </div>
          <div class="field">
            <label class="title">Jour du mois</label>
            <input id="abo-jour" type="number" min="1" max="31" value="5">
          </div>
        </div>

        <label class="title">Catégorie</label>
        <div class="select-wrap"><select id="abo-categorie"></select></div>

        <label class="toggle">
          <input id="abo-actif" type="checkbox" checked>
          <span>Actif (Oui)</span>
        </label>
      </div>

      <!-- PAIEMENT -->
      <div id="bloc-paiement" class="bloc" style="display:none">
        <div class="row">
          <div class="field">
            <label class="title">Date</label>
            <input id="date-paiement" type="date">
          </div>
          <div class="field">
            <label class="title">Montant (€)</label>
            <input id="montant-paiement" type="text" inputmode="decimal" placeholder="ex: 1000">
            <div class="hint">Décimales : virgule ou point</div>
          </div>
        </div>
      </div>

      <div id="feedback" class="msg" style="display:none"></div>
      <div id="error" class="err" style="display:none"></div>
    </main>

    <!-- BOUTON -->
    <div class="actions">
      <div class="wrap"><button id="submit">➕ Ajouter</button></div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzF3P3AE1hcHuyFRZLnBS9eKtu0nz1jVyLxv8Ej0CbA78G-_ssXd2e-I9zgk58qqke46w/exec";

    // ========= UI helpers =========
    const $ = id => document.getElementById(id);
    const blocs = {
      "Achat stock":"bloc-achat",
      "Frais annexes":"bloc-frais",
      "Vente/Cashout":"bloc-vente",
      "Abonnement (mensuel)":"bloc-abo",
      "Paiement":"bloc-paiement",
    };
    function switchTypeUI(){
      const t=$("type").value;
      Object.values(blocs).forEach(id=>document.getElementById(id).style.display="none");
      document.getElementById(blocs[t]).style.display="block";
      hideMsg();
    }
    $("type").addEventListener("change", switchTypeUI);

    function setToday(ids){
      const t=new Date(), y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,"0"), d=String(t.getDate()).padStart(2,"0");
      ids.forEach(id=>{ const el=$(id); if(el) el.value=`${y}-${m}-${d}`; });
    }

    function showMsg(text){ const el=$("feedback"); el.textContent=text; el.style.display="block"; $("error").style.display="none"; }
    function showErr(text){ const el=$("error"); el.textContent=text; el.style.display="block"; $("feedback").style.display="none"; }
    function hideMsg(){ $("feedback").style.display="none"; $("error").style.display="none"; }

    // ========= Lists =========
    function fill(selId, arr){ const sel=$(selId); sel.innerHTML=""; (arr||[]).forEach(v=>{const o=document.createElement("option"); o.value=o.textContent=v; sel.appendChild(o);}); }

    async function loadLists(){
      try{
        const r=await fetch(ENDPOINT+"?api=lists");
        const js=await r.json();
        const d=js.data||{};
        fill("fournisseur", d.fournisseurs);
        fill("categorie", d.categories);
        fill("compte-vinted", d.comptesVinted);
        fill("abo-categorie", d.categories);
      }catch(e){ showErr("Erreur listes : "+e.message); }
    }

    // Ajout d’une valeur Paramètres
    async function addParam(kind, promptLabel){
      const val=prompt(promptLabel+" :");
      if(!val) return;
      try{
        const params = new URLSearchParams({action:"addParam",kind,value:val});
        const r=await fetch(ENDPOINT,{method:"POST",headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:params.toString()});
        const js=await r.json();
        if(!js.ok) throw new Error(js.error||"Erreur ajout");
        const d=js.data||{};
        if(kind==="fournisseur") fill("fournisseur", d.fournisseurs);
        if(kind==="categorie"){ fill("categorie", d.categories); fill("abo-categorie", d.categories); }
        if(kind==="compteVinted") fill("compte-vinted", d.comptesVinted);
      }catch(e){ alert("Erreur : "+e.message); }
    }
    $("add-fs").addEventListener("click", ()=>addParam("fournisseur","Nouveau fournisseur"));
    $("add-cat").addEventListener("click", ()=>addParam("categorie","Nouvelle catégorie"));
    $("add-vinted").addEventListener("click", ()=>addParam("compteVinted","Nouveau compte Vinted"));

    // ========= submit =========
    function normMoney(v){ return String(v||"").replace(",", ".").trim(); } // comma ou point → OK

    $("submit").addEventListener("click", async ()=>{
      hideMsg();
      const btn=$("submit");
      const type=$("type").value;
      const p={ type };

      // récolte + validation mini
      try{
        if(type==="Achat stock"){
          if(!$("montant-achat").value) throw new Error("Montant requis (achat).");
          p.item=$("item").value;
          p.dateISO=$("date-achat").value;
          p.montant=normMoney($("montant-achat").value);
          p.fournisseur=$("fournisseur").value;

        }else if(type==="Frais annexes"){
          if(!$("montant-frais").value) throw new Error("Montant requis (frais).");
          p.fraisDesc=$("frais-desc").value;
          p.dateISO=$("date-frais").value;
          p.montant=normMoney($("montant-frais").value);
          p.categorie=$("categorie").value;

        }else if(type==="Vente/Cashout"){
          if(!$("montant-vente").value) throw new Error("Montant requis (vente).");
          p.dateISO=$("date-vente").value;
          p.montant=normMoney($("montant-vente").value);
          p.compteVinted=$("compte-vinted").value;

        }else if(type==="Abonnement (mensuel)"){
          if(!$("abo-montant").value) throw new Error("Montant requis (abonnement).");
          p.aboNom=$("abo-nom").value;
          p.montant=normMoney($("abo-montant").value);
          p.aboJour=$("abo-jour").value;
          p.categorie=$("abo-categorie").value;
          p.aboActif=$("abo-actif").checked;

        }else{ // Paiement
          if(!$("montant-paiement").value) throw new Error("Montant requis (paiement).");
          p.dateISO=$("date-paiement").value;
          p.montant=normMoney($("montant-paiement").value);
        }
      }catch(e){ return showErr(e.message); }

      // état "Ajout en cours…"
      btn.disabled=true;
      const original = btn.innerHTML;
      btn.innerHTML = `<span class="spin"></span>Ajout en cours…`;

      try{
        const params = new URLSearchParams();
        Object.entries(p).forEach(([k,v])=>params.append(k,String(v)));
        const r = await fetch(ENDPOINT,{method:"POST",headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:params.toString()});
        const js = await r.json().catch(()=>({}));
        if(!r.ok || js.ok===false) throw new Error(js.error || ("HTTP "+r.status));

        btn.innerHTML = "Ajouté ✅";
        showMsg("Ajouté ✅");
        // petit reset rapide des champs montants
        if(type==="Achat stock"){ $("montant-achat").value=""; $("item").value=""; }
        if(type==="Frais annexes"){ $("montant-frais").value=""; $("frais-desc").value=""; }
        if(type==="Vente/Cashout"){ $("montant-vente").value=""; }
        if(type==="Abonnement (mensuel)"){ $("abo-montant").value=""; $("abo-nom").value=""; }
        if(type==="Paiement"){ $("montant-paiement").value=""; }
      }catch(e){
        btn.innerHTML = original;
        showErr("Erreur : "+e.message);
        btn.disabled=false;
        return;
      }

      // retour à l’état normal après 1.2s
      setTimeout(()=>{ btn.innerHTML = original; btn.disabled=false; }, 1200);
    });

    // ========= init =========
    (function init(){
      setToday(["date-achat","date-frais","date-vente","date-paiement"]);
      loadLists();
      switchTypeUI();
      // case Actif : déjà cochée & cliquable (label for + taille)
      $("abo-actif").checked = true;
    })();
  </script>
</body>
</html>
